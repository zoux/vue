## 数据驱动

### new Vue 发生了什么

Vue 初始化主要就干了几件事情：合并配置，初始化生命周期，初始化事件中心，初始化渲染，初始化 data、props、computed、watcher 等。

在初始化的最后，检测到如果有 el 属性，则调用 vm.$mount 方法挂载 vm。

### Vue 实例挂载的实现（即 $mount 的实现）

1. 首先对 el 做了限制，Vue 不能挂载在 body、html 这样的根节点上。
2. 如果没有定义 render 方法，则会把 el 或者 template 转换成 render 方法。因为在 Vue 2.x 中，所有 Vue 的组件的渲染最终都需要 render 方法。
3. 调用 mountComponent 方法完成渲染工作。

mountComponent 方法的核心是先实例化一个渲染 Watcher，在它的回调函数中会调用 updateComponent 方法。
在此方法中调用 vm._render 方法先生成虚拟 Node，最终调用 vm._update 更新 DOM。

> Watcher 在这里起到两个作用，一是初始化的时候会执行回调函数，二是当 vm 实例中的监测的数据发生变化的时候执行回调函数。

### render

vm._render 最终是通过执行 _createElement 方法并返回的是 VNode。

### Virtual DOM

在 Vue.js 中，Virtual DOM 是用 VNode 这个 Class 去描述的。VNode 借鉴了一个开源库 snabbdom 的实现，然后加入了一些 Vue.js 特色的东西。

VNode 是对真实 DOM 的一种抽象描述，它的核心定义无非就几个关键属性，标签名、数据、子节点、键值等，其它属性都是用来扩展 VNode 的灵活性以及实现一些特殊 feature 的。

由于 VNode 只是用来映射到真实 DOM 的渲染，不需要包含操作 DOM 的方法，因此它是非常轻量和简单的。

映射到真实的 DOM 实际上要经历 VNode 的 create、diff、patch 等过程。

### createElement

_createElement 会对参数 tag 进行判断：
* 如果是一个普通的 html 标签，则会实例化一个普通 VNode 节点。
* 否则通过 createComponent 方法创建一个组件 VNode 节点。

### update

_update 的作用是把 VNode 渲染成真实的 DOM。它被调用的时机有 2 个，一个是首次渲染，一个是数据更新的时候。

其核心就是调用 `vm.__patch__(prevVnode, currentVnode)` 方法：
1. patch 主要调用了 createElm(通过虚拟节点创建真实的 DOM 并插入到它的父节点中)。
2. createElm 主要调用了 createComponent(尝试创建子组件)、createChildren(创建子元素)、insert(把 DOM 插入到父节点中)。

> createChildren 实际上是遍历子虚拟节点，递归调用 createElm，这是一种常用的深度优先的遍历算法。

> 因为是递归调用，子元素会优先调用 insert，所以整个 vnode 树节点的插入顺序是先子后父。
